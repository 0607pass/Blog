{{ $bg := .Site.Params.background }}
{{ $font := .Site.Params.font }}
{{ $mouse := .Site.Params.mouse }}

{{ $sakuraURL := "" }}
{{ $particlesScriptURL := "" }}
{{ $particlesConfigURL := "" }}
{{ $fontURL := "" }}
{{ $cursorDefaultURL := "" }}
{{ $cursorPointerURL := "" }}
{{ $cursorTextURL := "" }}

{{ if and $bg $bg.enableSakura $bg.sakuraScript (resources.Get $bg.sakuraScript) }}
  {{ $sakuraURL = (resources.Get $bg.sakuraScript).Permalink }}
{{ end }}
{{ if and $bg $bg.enableParticles $bg.particlesScript $bg.particlesConfig (resources.Get $bg.particlesScript) (resources.Get $bg.particlesConfig) }}
  {{ $particlesScriptURL = (resources.Get $bg.particlesScript).Permalink }}
  {{ $particlesConfigURL = (resources.Get $bg.particlesConfig).Permalink }}
{{ end }}
{{ if and $font $font.enable $font.file (resources.Get $font.file) }}
  {{ $fontURL = (resources.Get $font.file).Permalink }}
{{ end }}
{{ if and $mouse $mouse.enable $mouse.default }}
  {{ $cursorDefaultURL = printf "mouse/%s" $mouse.default | relURL }}
{{ end }}
{{ if and $mouse $mouse.enable $mouse.pointer }}
  {{ $cursorPointerURL = printf "mouse/%s" $mouse.pointer | relURL }}
{{ end }}
{{ if and $mouse $mouse.enable $mouse.text }}
  {{ $cursorTextURL = printf "mouse/%s" $mouse.text | relURL }}
{{ end }}

<style>
    /* 自定义字体（可选） */
    {{- if and $fontURL $font.name -}}
    @font-face {
        font-family: '{{ $font.name }}';
        src: url({{ $fontURL }}) format('truetype');
        font-display: swap;
    }
    :root {
        --base-font-family: '{{ $font.name }}', var(--sys-font-family), var(--zh-font-family), sans-serif;
        --article-font-family: var(--base-font-family);
        --code-font-family: '{{ $font.name }}', var(--zh-font-family), monospace;
    }
    body {
        font-family: var(--base-font-family);
    }
    {{- end -}}

    /* 自定义鼠标样式（可选） */
    {{- if and $mouse $mouse.enable -}}
    {{- if $cursorDefaultURL }}
    body, html {
        cursor: url("{{ $cursorDefaultURL }}"), auto !important;
    }
    .article-content img {
        cursor: url("{{ $cursorDefaultURL }}"), auto !important;
    }
    {{- end -}}
    {{- if $cursorPointerURL }}
    a:hover, button:hover, .copyCodeButton:hover, #dark-mode-toggle {
        cursor: url("{{ $cursorPointerURL }}"), auto;
    }
    {{- end -}}
    {{- if $cursorTextURL }}
    input:hover, .site-description, .article-subtitle, .article-content span, .article-content li, .article-content p {
        cursor: url("{{ $cursorTextURL }}"), auto;
    }
    {{- end -}}
    {{- end -}}

    /* 文章目录折叠&展开样式 */
    #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }

    /* 返回顶部按钮样式 */
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        {{- if (resources.Get "icons/backTop.svg") -}}
        background-image: url({{ (resources.Get "icons/backTop.svg").Permalink }});
        {{- else -}}
        background: var(--accent-color);
        border-radius: 50%;
        {{- end -}}
        background-size: contain;
        background-repeat: no-repeat;
    }
    {{- if not (resources.Get "icons/backTop.svg") -}}
    #backTopBtn:before {
        content: "↑";
        color: var(--accent-color-text);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        font-size: 20px;
    }
    {{- end -}}

    /* 代码块折叠样式 */
    .highlight {
        /* 你可以根据需要调整这个高度 */
        max-height: 400px;
        overflow: hidden;
        position: relative;
    }
    .code-show {
        max-height: none !important;
    }
    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }
    [data-scheme="dark"] .code-more-box {
        background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(66, 66, 66, 0)), to(#424242));
    }
    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: #f0f0f5;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
    }
    [data-scheme="dark"] .code-more-btn {
        background: #545454;
    }
    .code-more-img {
        cursor: pointer !important;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }

    /* 静态背景图 */
    {{- if and $bg $bg.enableImage $bg.image (resources.Get $bg.image) -}}
    body {
        background: url({{ (resources.Get $bg.image).Permalink }}) no-repeat center top;
        background-size: cover;
        background-attachment: fixed;
    }
    {{- end -}}

    /* particles.js 背景容器 */
    #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
    }
</style>

<!-- APlayer 音乐播放器 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<div id="aplayer"></div>
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script>

<script>
    /**
     * 文章目录折叠&展开初始化
     */
    function initTocHide() {
        // 判断是否存在文章目录
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        // 监听滚动
        window.addEventListener('scroll', function() {
            //清除class值
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            // 获取active-class
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            // 展示子ul
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            // 展示父ul
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }

    /**
     * 滚动回顶部初始化
     */
    function initScrollTop() {
        let rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) {
            return;
        }
        // 添加返回顶部按钮到右侧边栏
        let btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop
        rightSideBar.appendChild(btn)
        // 滚动监听
        window.onscroll = function() {
            // 当网页向下滑动 20px 出现"返回顶部" 按钮
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        };
    }

    /**
     * 返回顶部
     */
    function backToTop(){
        window.scrollTo({ top: 0, behavior: "smooth" })
    }

    /**
     * 代码块折叠初始化
     */
    function initCodeMoreBox() {
        let codeBlocks = document.querySelectorAll(".highlight");
        if (!codeBlocks) {
            return;
        }
        codeBlocks.forEach(codeBlock => {
            // 校验是否overflow
            if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
                return;
            }
            // 元素初始化
            // codeMoreBox
            let codeMoreBox = document.createElement('div');
            codeMoreBox.classList.add('code-more-box');
            // codeMoreBtn
            let codeMoreBtn = document.createElement('span');
            codeMoreBtn.classList.add('code-more-btn');
            codeMoreBtn.addEventListener('click', () => {
                codeBlock.classList.add('code-show');
                codeMoreBox.style.display = 'none';
                // 触发resize事件，重新计算目录位置
                window.dispatchEvent(new Event('resize'))
            })
            // img
            {{- if (resources.Get "icons/codeMore.png") -}}
            let img = document.createElement('img');
            img.classList.add('code-more-img');
            img.src = {{ (resources.Get "icons/codeMore.png").Permalink }}
            codeMoreBtn.appendChild(img);
            {{- else -}}
            codeMoreBtn.textContent = "展开";
            codeMoreBtn.style.padding = "4px 8px";
            codeMoreBtn.style.fontSize = "12px";
            {{- end -}}
            // 元素添加
            codeMoreBox.appendChild(codeMoreBtn);
            codeBlock.appendChild(codeMoreBox)
        })
    }

    /**
     * 静态/动态背景初始化
     */
    function initBackground() {
        // 确保静态背景图在 PJAX 导航后正确显示
        {{- $bgImagePermalink := "" -}}
        {{- if and $bg $bg.enableImage $bg.image (resources.Get $bg.image) -}}
        {{- $bgImagePermalink = (resources.Get $bg.image).Permalink -}}
        {{- end -}}
        const bgImageUrl = "{{ $bgImagePermalink }}";
        if (bgImageUrl && document.body) {
            // 强制重新应用背景样式，确保在 PJAX 导航后背景正常显示
            document.body.style.backgroundImage = `url(${bgImageUrl})`;
            document.body.style.backgroundRepeat = 'no-repeat';
            document.body.style.backgroundPosition = 'center top';
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundAttachment = 'fixed';
        }

        // Sakura 动态背景
        const sakuraUrl = "{{ $sakuraURL }}";
        if (sakuraUrl) {
            // 在 PJAX 导航时，需要重新初始化 Sakura
            // 先清理旧的实例（如果存在）
            if (window.__sakuraInstance) {
                try {
                    // 如果 Sakura 有销毁方法，调用它
                    if (typeof window.__sakuraInstance.destroy === 'function') {
                        window.__sakuraInstance.destroy();
                    }
                } catch (e) {
                    console.warn('Sakura cleanup error:', e);
                }
            }
            
            // 重新加载 Sakura 脚本
            const existingSakuraScript = document.querySelector('script[src="' + sakuraUrl + '"]');
            if (existingSakuraScript) {
                existingSakuraScript.remove();
            }
            
            const sakuraScript = document.createElement("script");
            sakuraScript.src = sakuraUrl;
            sakuraScript.onload = () => {
                // 标记 Sakura 已加载
                window.__sakuraInstance = true;
            };
            document.body.appendChild(sakuraScript);
        }

        // particles.js 动态背景
        const particlesScriptUrl = "{{ $particlesScriptURL }}";
        const particlesConfigUrl = "{{ $particlesConfigURL }}";
        if (particlesScriptUrl && particlesConfigUrl) {
            // 避免重复创建容器
            let particlesContainer = document.getElementById("particles-js");
            if (!particlesContainer) {
                particlesContainer = document.createElement("div");
                particlesContainer.id = "particles-js";
                document.body.prepend(particlesContainer);
            }

            // 先销毁已有实例，避免叠加导致看起来“变快”
            if (window.pJSDom && window.pJSDom.length) {
                window.pJSDom.forEach((p) => {
                    if (p.pJS && p.pJS.fn && p.pJS.fn.vendors && p.pJS.fn.vendors.destroypJS) {
                        p.pJS.fn.vendors.destroypJS();
                    }
                });
                window.pJSDom = [];
            }

            // 避免重复加载脚本
            if (!window.__particlesScriptLoaded) {
                window.__particlesScriptLoaded = true;
                const particlesScript = document.createElement("script");
                particlesScript.src = particlesScriptUrl;
                particlesScript.onload = () => {
                    if (window.particlesJS) {
                        window.particlesJS.load("particles-js", particlesConfigUrl);
                    }
                };
                document.body.appendChild(particlesScript);
            } else if (window.particlesJS) {
                // PJAX 场景下重复加载配置，保持同一实例参数
                // 使用 setTimeout 确保 DOM 已更新
                setTimeout(() => {
                    if (window.particlesJS && document.getElementById("particles-js")) {
                        window.particlesJS.load("particles-js", particlesConfigUrl);
                    }
                }, 100);
            }
        }
    }

    function initAll() {
        initTocHide();
        initScrollTop();
        initCodeMoreBox();
        initBackground();
        if (window.Stack && typeof window.Stack.init === 'function') {
            window.Stack.init();
        }
    }

    // 初始化所有功能
    initAll();

    /**
     * 音乐播放器初始化
     * 参考：https://letere-gzj.github.io/hugo-stack/p/hugo/custom-player/
     */
    (function initAPlayer() {
        if (window.__aplayerInstance) {
            return; // 避免重复初始化
        }
        const container = document.getElementById('aplayer');
        if (!container || !window.APlayer) {
            return;
        }

        // 本地资源前缀，encodeURIComponent 处理中文/特殊字符
        const staticDir = "{{ .Site.Home.Permalink }}";
        const toUrl = (file) => `${staticDir}mp3/${encodeURIComponent(file)}`;

        // TODO: 替换封面或歌词路径（如有）
        const audioList = [
            {
                name: '可惜没如果',
                artist: '林俊杰',
                url: toUrl('林俊杰-可惜没如果.mp3'),
                cover: 'https://picsum.photos/200/200?random=13'
            },
            {
                name: '查无此字',
                artist: '林奕匡',
                url: toUrl('查无此字-林奕匡#eQSOo.mp3'),
                cover: 'https://picsum.photos/200/200?random=11'
            },
            {
                name: '我怀念的',
                artist: '孙燕姿',
                url: toUrl('孙燕姿-我怀念的.mp3'),
                cover: 'https://picsum.photos/200/200?random=12'
            },
            {
                name: '老男孩',
                artist: '筷子兄弟',
                url: toUrl('筷子兄弟-老男孩.mp3'),
                cover: 'https://picsum.photos/200/200?random=14'
            }
        ];

        if (!audioList.length) {
            return;
        }

        const STORAGE_KEY = 'aplayer-play-info';
        let pendingRestore = null;

        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            pendingRestore = saved ? JSON.parse(saved) : null;
        } catch (err) {
            console.error('APlayer restore parse error', err);
        }

        const ap = new APlayer({
            container,
            fixed: true,
            autoplay: false,
            lrcType: 0,
            theme: '#409EFF',
            audio: audioList
        });
        window.__aplayerInstance = ap;

        const savePlayInfo = () => {
            if (!ap.audio) return;
            const payload = {
                index: ap.list.index || 0,
                currentTime: ap.audio.currentTime || 0,
                paused: ap.audio.paused
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        };

        /**
         * 页面销毁/隐藏前保存播放进度（兼容 navigate/back）
         */
        window.addEventListener('beforeunload', savePlayInfo);
        window.addEventListener('pagehide', savePlayInfo);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                savePlayInfo();
            }
        });

        /**
         * 恢复播放状态
         */
        if (pendingRestore) {
            const { index = 0, currentTime = 0, paused = true } = pendingRestore;
            const applyRestore = () => {
                try {
                    if (index >= 0 && index < audioList.length) {
                        ap.list.switch(index);
                    }
                    ap.seek(currentTime || 0);
                    if (paused === false) {
                        ap.play();
                    } else {
                        ap.pause();
                    }
                } catch (err) {
                    console.error('APlayer restore failed', err);
                } finally {
                    pendingRestore = null;
                }
            };

            // 等待音频可播放后再恢复进度
            ap.on('canplay', function handleRestore() {
                ap.off('canplay', handleRestore);
                applyRestore();
            });
        }
    })();

    /**
     * 初始化 PJAX，保持播放器不销毁，减少导航中断
     */
    (function initPjax() {
        if (window.__pjaxInstance || !window.Pjax) return;

        window.__pjaxInstance = new Pjax({
            selectors: ["title", ".main-container"],
            cacheBust: false
        });

        document.addEventListener('pjax:complete', () => {
            // 重新挂载页面交互，不重复创建播放器
            // 使用 setTimeout 确保 DOM 完全更新后再初始化背景
            setTimeout(() => {
                initAll();
            }, 50);
        });
        
        // 监听 PJAX 开始事件，确保背景容器在导航过程中保持可见
        document.addEventListener('pjax:send', () => {
            // 确保背景容器在导航过程中仍然存在
            const particlesContainer = document.getElementById("particles-js");
            if (particlesContainer) {
                particlesContainer.style.display = 'block';
            }
        });
    })();
</script>
