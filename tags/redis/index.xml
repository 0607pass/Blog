<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Redis on XFFF çš„ç‹¬ç«‹åšå®¢</title><link>https://0607pass.github.io/Blog/tags/redis/</link><description>Recent content in Redis on XFFF çš„ç‹¬ç«‹åšå®¢</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>Â© {year} XFFF</copyright><lastBuildDate>Mon, 01 Jan 0001 00:00:00 +0000</lastBuildDate><atom:link href="https://0607pass.github.io/Blog/tags/redis/index.xml" rel="self" type="application/rss+xml"/><item><title>Redisä¸­Hashæ•°æ®ç»“æ„ï¼ŒåŠrehash</title><link>https://0607pass.github.io/Blog/p/redis%E4%B8%ADhash%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8Arehash/</link><pubDate>Thu, 11 Dec 2025 14:57:56 +0800</pubDate><guid>https://0607pass.github.io/Blog/p/redis%E4%B8%ADhash%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8Arehash/</guid><description>&lt;img src="https://0607pass.github.io/Blog/images/postCover/redis.png" alt="Featured image of post Redisä¸­Hashæ•°æ®ç»“æ„ï¼ŒåŠrehash" /&gt;&lt;h2 id="hashæ•°æ®ç»“æ„"&gt;Hashæ•°æ®ç»“æ„
&lt;/h2&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;dict&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;dictType&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="cm"&gt;/*æŒ‡å‘ä¸¤ä¸ªht_table ç”¨æ¥rehash */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;dictEntry&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;ht_table&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;ht_used&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;rehashidx&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* rehashing not in progress if rehashidx == -1 */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="cm"&gt;/* Keep small vars at end for optimal (minimal) struct padding */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;int16_t&lt;/span&gt; &lt;span class="n"&gt;pauserehash&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* If &amp;gt;0 rehashing is paused (&amp;lt;0 indicates coding error) */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;signed&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;ht_size_exp&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt; &lt;span class="cm"&gt;/* exponent of size. (size = 1&amp;lt;&amp;lt;exp) */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;dictType å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å¦ä¸€ä¸ªç»“æ„ä½“ &lt;code&gt;dictType&lt;/code&gt;ï¼Œå®ƒå®šä¹‰äº†è¿™ä¸ªå­—å…¸çš„â€œè¡Œä¸ºå‡½æ•°â€ï¼Œæ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚ä½•è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼ˆ&lt;code&gt;hashFunction&lt;/code&gt;ï¼‰&lt;/li&gt;
&lt;li&gt;å¦‚ä½•æ¯”è¾ƒ key æ˜¯å¦ç›¸ç­‰ï¼ˆ&lt;code&gt;keyCompare&lt;/code&gt;ï¼‰&lt;/li&gt;
&lt;li&gt;å¦‚ä½•é‡Šæ”¾å†…å­˜ï¼ˆ&lt;code&gt;keyDestructor&lt;/code&gt;ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;dictEntry **ht_table[2] ä»€ä¹ˆä½œç”¨&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªâ€œå“ˆå¸Œæ¡¶æ•°ç»„â€ã€‚&lt;/p&gt;
&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ï¼ŒRedis çš„å­—å…¸ç»“æ„åŒ…å« &lt;strong&gt;ä¸¤ä¸ªå“ˆå¸Œè¡¨&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æ¯ä¸ª &lt;code&gt;ht_table[i]&lt;/code&gt; æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆæ•°ç»„é‡Œçš„æ¯ä¸€é¡¹éƒ½æ˜¯é“¾è¡¨å¤´ &lt;code&gt;dictEntry*&lt;/code&gt;ï¼‰ï¼Œç”¨æ¥å¤„ç†å“ˆå¸Œå†²çªã€‚&lt;/p&gt;
&lt;h2 id="ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªå“ˆå¸Œè¡¨"&gt;ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Ÿ
&lt;/h2&gt;&lt;p&gt;ä¸ºäº†æ”¯æŒ &lt;strong&gt;æ¸è¿›å¼ rehashï¼ˆæ…¢æ…¢è¿ç§»ï¼Œä¸ä¸€æ¬¡è¿ç§»æ‰€æœ‰é”®ï¼‰&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Redis ä¼šå…ˆåœ¨ &lt;code&gt;ht_table[0]&lt;/code&gt; ä¸Šå·¥ä½œã€‚&lt;/li&gt;
&lt;li&gt;å½“éœ€è¦æ‰©å®¹æˆ–ç¼©å®¹æ—¶ï¼Œä¼šç”³è¯·æ–°çš„å“ˆå¸Œè¡¨ &lt;code&gt;ht_table[1]&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;ç„¶åé€æ­¥æŠŠæ—§æ•°æ®ä» &lt;code&gt;ht_table[0]&lt;/code&gt; è¿ç§»åˆ° &lt;code&gt;ht_table[1]&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™æ ·é¿å…äº†æš‚åœæ•´ä¸ªæœåŠ¡å™¨åš rehash çš„é—®é¢˜ï¼Œæå‡å“åº”æ€§ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;unsigned long ht_used[2]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™ä¸ªæ•°ç»„è®°å½•äº†ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸­å®é™…å­˜å‚¨äº†å¤šå°‘ä¸ªé”®å€¼å¯¹ï¼ˆèŠ‚ç‚¹ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ht_used[0]&lt;/code&gt;: ä¸»è¡¨å·²ç”¨çš„ entry æ•°é‡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ht_used[1]&lt;/code&gt;: è¿ç§»ç›®æ ‡è¡¨çš„ entry æ•°é‡ï¼ˆrehash æœŸé—´ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;long rehashidx;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;rehash çš„&lt;strong&gt;å½“å‰ä½ç½®ç´¢å¼•&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœç­‰äº &lt;code&gt;-1&lt;/code&gt;ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰åœ¨è¿›è¡Œ rehashï¼›&lt;/li&gt;
&lt;li&gt;å¦‚æœå¤§äºç­‰äº &lt;code&gt;0&lt;/code&gt;ï¼Œè¯´æ˜æ­£åœ¨è¿›è¡Œ rehashï¼Œå€¼è¡¨ç¤ºå½“å‰å·²ç»è¿ç§»åˆ°å“ªä¸€ä¸ªæ¡¶ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Redis æ¯æ¬¡æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šé¡ºä¾¿è¿ç§»ä¸€å°éƒ¨åˆ†æ¡¶ï¼ˆæ¸è¿›å¼è¿ç§»ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªå˜é‡è·Ÿè¸ªè¿›åº¦ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;int16_t pauserehash;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ˜¯å¦æš‚åœ rehash æ“ä½œï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;0&lt;/code&gt;ï¼šæ­£å¸¸&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;gt;0&lt;/code&gt;ï¼šrehash è¢«æš‚æ—¶æš‚åœï¼ˆæŸäº›å‘½ä»¤æˆ–æ“ä½œæœŸé—´ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;0&lt;/code&gt;ï¼šè¡¨ç¤ºæœ‰ bugï¼ŒRedis ä¼šæŠ¥é”™ï¼ˆç†è®ºä¸Šä¸ä¼šå‡ºç°ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;signed char ht_size_exp[2];&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¡¨ç¤ºä¸¤ä¸ªå“ˆå¸Œè¡¨çš„&lt;strong&gt;å¤§å°çš„æŒ‡æ•°&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å“ˆå¸Œè¡¨çš„å®¹é‡æ˜¯ &lt;code&gt;2 çš„å¹‚æ¬¡æ–¹&lt;/code&gt;ï¼Œå³ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;ht_size_exp&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è¿™æ¯”å­˜å‚¨å®é™…å¤§å°æ›´èŠ‚çœç©ºé—´ï¼Œè€Œä¸”æ–¹ä¾¿ Redis ä½¿ç”¨ä½è¿ç®—è®¡ç®—å“ˆå¸Œå€¼å’Œæ¡¶ä½ç½®ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„"&gt;å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„
&lt;/h1&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;typedef&lt;/span&gt; &lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;dictEntry&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;union&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;val&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;uint64_t&lt;/span&gt; &lt;span class="n"&gt;u64&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;int64_t&lt;/span&gt; &lt;span class="n"&gt;s64&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;double&lt;/span&gt; &lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;dictEntry&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;next&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Next entry in the same hash bucket. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;metadata&lt;/span&gt;&lt;span class="p"&gt;[];&lt;/span&gt; &lt;span class="cm"&gt;/* An arbitrary number of bytes (starting at a
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; * pointer-aligned address) of size as returned
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; * by dictType&amp;#39;s dictEntryMetadataBytes(). */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;dictEntry&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;dictEntry ç»“æ„é‡Œé”®å€¼å¯¹ä¸­çš„å€¼æ˜¯ä¸€ä¸ªã€Œè”åˆä½“ vã€å®šä¹‰çš„ï¼Œå› æ­¤ï¼Œé”®å€¼å¯¹ä¸­çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡å‘å®é™…å€¼çš„æŒ‡é’ˆï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„ 64 ä½æ•´æ•°æˆ–æœ‰ç¬¦å·çš„ 64 ä½æ•´æ•°æˆ–double ç±»çš„å€¼ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯å¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå› ä¸ºå½“ã€Œå€¼ã€æ˜¯æ•´æ•°æˆ–æµ®ç‚¹æ•°æ—¶ï¼Œå°±å¯ä»¥å°†å€¼çš„æ•°æ®å†…åµŒåœ¨ dictEntry ç»“æ„é‡Œï¼Œæ— éœ€å†ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å®é™…çš„å€¼ï¼Œä»è€ŒèŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚&lt;/p&gt;</description></item><item><title>Redissonä¸­çš„Watch Dogæœºåˆ¶</title><link>https://0607pass.github.io/Blog/p/redisson%E4%B8%AD%E7%9A%84watch-dog%E6%9C%BA%E5%88%B6/</link><pubDate>Thu, 11 Dec 2025 14:57:05 +0800</pubDate><guid>https://0607pass.github.io/Blog/p/redisson%E4%B8%AD%E7%9A%84watch-dog%E6%9C%BA%E5%88%B6/</guid><description>&lt;img src="https://0607pass.github.io/Blog/images/postCover/redis.png" alt="Featured image of post Redissonä¸­çš„Watch Dogæœºåˆ¶" /&gt;&lt;h1 id="redissonä¸­é»˜è®¤é”è¡Œä¸º"&gt;Redissonä¸­é»˜è®¤é”è¡Œä¸º
&lt;/h1&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-java" data-lang="java"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;RLock&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;redisson&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getLock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#34;anyLock&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="w"&gt;&lt;/span&gt;&lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="na"&gt;lock&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;ä¸æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼›&lt;/li&gt;
&lt;li&gt;é»˜è®¤ç”±çœ‹é—¨ç‹—æœºåˆ¶æ§åˆ¶é”çš„ç”Ÿå‘½å‘¨æœŸï¼›&lt;/li&gt;
&lt;li&gt;é»˜è®¤é”è¿‡æœŸæ—¶é—´ä¸º 30 ç§’ï¼›&lt;/li&gt;
&lt;li&gt;æ¯ 10 ç§’è‡ªåŠ¨ç»­æœŸï¼ˆå³ï¼šæ¯æ¬¡é‡è®¾ä¸º 30 ç§’åè¿‡æœŸï¼‰ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="ä¸ºä»€ä¹ˆé€‰æ‹©æ¯10ç§’ç»­æœŸ"&gt;ä¸ºä»€ä¹ˆé€‰æ‹©æ¯10ç§’ç»­æœŸ
&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;æœ‰å®¹é”™ï¼Œå¦‚ä½•æœ‰ç½‘ç»œå¼‚å¸¸å¯¼è‡´ç¬¬ä¸€æ¬¡ç»­æœŸæ²¡æœ‰æˆåŠŸåˆ™è¿˜æœ‰2 æœºä¼šã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœç»­æœŸå¤ªé¢‘ç¹ï¼ˆå¦‚æ¯ 1 ç§’ï¼‰ï¼Œä¼šå¢åŠ  Redis çš„å‹åŠ›ï¼ˆé¢‘ç¹ PEXPIRE è°ƒç”¨ï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;å¦‚æœç»­æœŸå¤ªå°‘ï¼ˆæ¯”å¦‚ 25 ç§’æ‰ç»­æœŸä¸€æ¬¡ï¼‰ï¼Œå®¹é”™ç©ºé—´å¤ªå°ï¼Œä¸€æ—¦æŸä¸€æ¬¡å¤±è´¥å°±ä¼šå¾ˆå±é™©ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="é»˜è®¤è¿‡æœŸæ—¶é—´30ç§’å¯ä»¥ä¿®æ”¹"&gt;é»˜è®¤è¿‡æœŸæ—¶é—´30ç§’å¯ä»¥ä¿®æ”¹
&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;lockWatchdogTimeout
Redisson ä¼šä»¥ lockWatchdogTimeout / 3 çš„é¢‘ç‡è¿›è¡Œç»­æœŸã€‚&lt;/p&gt;
&lt;/blockquote&gt;</description></item><item><title>Redisæœ‰å“ªäº›å·§å¦™çš„è®¾è®¡ï¼Œä¸¾å‡ ä¸ªä¾‹å­</title><link>https://0607pass.github.io/Blog/p/redis%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B7%A7%E5%A6%99%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%BE%E5%87%A0%E4%B8%AA%E4%BE%8B%E5%AD%90/</link><pubDate>Thu, 11 Dec 2025 14:54:01 +0800</pubDate><guid>https://0607pass.github.io/Blog/p/redis%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B7%A7%E5%A6%99%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%BE%E5%87%A0%E4%B8%AA%E4%BE%8B%E5%AD%90/</guid><description>&lt;img src="https://0607pass.github.io/Blog/images/postCover/redis.png" alt="Featured image of post Redisæœ‰å“ªäº›å·§å¦™çš„è®¾è®¡ï¼Œä¸¾å‡ ä¸ªä¾‹å­" /&gt;&lt;h1 id="5ä¸ªæ–¹é¢"&gt;5ä¸ªæ–¹é¢
&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;çº¿ç¨‹æ¨¡å‹ã€æ•°æ®ç»“æ„ã€å…±äº«å¯¹è±¡æ± ã€è¿‡æœŸè®¾è®¡ã€æ•°æ®æŒä¹…åŒ–è®¾è®¡&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="ä¸€çº¿ç¨‹æ¨¡å‹"&gt;ä¸€ã€çº¿ç¨‹æ¨¡å‹
&lt;/h2&gt;&lt;p&gt;Redis ä½¿ç”¨&lt;strong&gt;å•çº¿ç¨‹æ¨¡å‹&lt;/strong&gt;æ¥å¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;è™½ç„¶çœ‹ä¼¼å•çº¿ç¨‹ç®€å•ï¼Œä½†è¿™ç§è®¾è®¡å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œé”çš„å¼€é”€ï¼Œé¿å…äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„å¤æ‚æ€§ã€‚&lt;/p&gt;
&lt;p&gt;å¹¶ä¸”é€šè¿‡&lt;strong&gt;å¤šè·¯å¤ç”¨&lt;/strong&gt;ï¼ˆepollã€select ç­‰ï¼‰+ &lt;strong&gt;äº‹ä»¶é©±åŠ¨&lt;/strong&gt;æœºåˆ¶ï¼ŒRedis ä»ç„¶èƒ½å¤Ÿå¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ã€‚&lt;/p&gt;
&lt;h2 id="äºŒæ•°æ®ç»“æ„"&gt;äºŒã€æ•°æ®ç»“æ„
&lt;/h2&gt;&lt;p&gt;Redis å¯¹å¾ˆå¤šæ•°æ®ç»“æ„è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¾‹å¦‚ sdsã€ziplistï¼Œè¿˜æœ‰å“ˆå¸Œè¡¨çš„æ‰©å®¹æœºåˆ¶ã€‚&lt;/p&gt;
&lt;h3 id="sdssimple-dynamic-string"&gt;SDS(Simple Dynamic String)
&lt;/h3&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="nf"&gt;__attribute__&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;__packed__&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="n"&gt;sdshdr16&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;uint16_t&lt;/span&gt; &lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* used */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;uint16_t&lt;/span&gt; &lt;span class="n"&gt;alloc&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* excluding the header and null terminator */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;flags&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* 3 lsb of type, 5 unused bits */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;[];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;åŠ¨æ€æ‰©å±•å’Œç©ºé—´é¢„åˆ†é…&lt;/strong&gt;ï¼šSDS æ”¯æŒè‡ªåŠ¨æ‰©å±•ã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å¢åŠ æ—¶ï¼ŒSDS ä¼šè‡ªåŠ¨åˆ†é…æ›´å¤§çš„å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”é€šå¸¸ä¼šé¢å¤–é¢„ç•™ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œå‡å°‘é¢‘ç¹çš„å†…å­˜åˆ†é…æ“ä½œï¼Œè¿™æ ·å°±é¿å…äº†æ¯æ¬¡ä¿®æ”¹å­—ç¬¦ä¸²æ—¶éƒ½éœ€è¦é‡æ–°åˆ†é…å†…å­˜çš„å¼€é”€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;äºŒè¿›åˆ¶å®‰å…¨:&lt;/strong&gt; ä¸ C å­—ç¬¦ä¸²ä¸åŒï¼ŒSDS æ”¯æŒå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼Œå› ä¸ºå®ƒä¸ä¼šä¾èµ–äºç©ºå­—ç¬¦ï¼ˆ&amp;rsquo;\0&amp;rsquo;ï¼‰æ¥æ ‡è¯†å­—ç¬¦ä¸²çš„ç»“æŸã€‚è¿™ä½¿å¾— SDS å¯ä»¥å®‰å…¨åœ°å­˜å‚¨å’Œå¤„ç†ä»»æ„äºŒè¿›åˆ¶æ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¸¸æ•°æ—¶é—´è·å–å­—ç¬¦ä¸²çš„é•¿åº¦&lt;/strong&gt; ï¼šSDS ç»“æ„ä¸­ä¼šé¢å¤–å­˜å‚¨å­—ç¬¦ä¸²çš„å½“å‰é•¿åº¦ï¼Œè¿™ä½¿å¾—è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ“ä½œå¯ä»¥åœ¨ O(1) æ—¶é—´å†…å®Œæˆï¼Œè€Œä¸åƒ C å­—ç¬¦ä¸²é‚£æ ·éœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²æ¥è®¡ç®—é•¿åº¦ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é˜²æ­¢ç¼“å†²åŒºæº¢å‡º&lt;/strong&gt;ï¼šSDS é€šè¿‡ç»´æŠ¤åˆ†é…ç©ºé—´çš„æ€»é•¿åº¦å’Œå·²ç”¨é•¿åº¦ï¼Œèƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ã€‚è¿™åœ¨ä½¿ç”¨ C å­—ç¬¦ä¸²æ—¶æ˜¯ä¸€ä¸ªå¸¸è§çš„å®‰å…¨éšæ‚£ï¼Œä½†åœ¨ SDS ä¸­å¾—åˆ°äº†å¾ˆå¥½è§£å†³ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æƒ°æ€§ç©ºé—´é‡Šæ”¾&lt;/strong&gt; ï¼š å½“ SDS ä¸­çš„å­—ç¬¦ä¸²é•¿åº¦ç¼©çŸ­æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³ç¼©å‡å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯ä¼šä¿ç•™éƒ¨åˆ†ç¼©çŸ­åçš„ç©ºé—´ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹çš„å†…å­˜é‡æ–°åˆ†é…æ“ä½œã€‚è¿™ç§ç­–ç•¥ä¹Ÿæ˜¯ Redis çš„å†…å­˜ä¼˜åŒ–çš„ä¸€éƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="ziplistå‹ç¼©åˆ—è¡¨"&gt;ziplist(å‹ç¼©åˆ—è¡¨)
&lt;/h3&gt;&lt;p&gt;å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯ Redis ç”¨äºå®ç°åˆ—è¡¨å’Œå“ˆå¸Œè¡¨çš„åº•å±‚æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚&lt;/p&gt;
&lt;p&gt;å½“åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨ä¸­çš„æ•°æ®é‡è¾ƒå°ï¼Œä¸”å…ƒç´ é•¿åº¦è¾ƒçŸ­æ—¶ï¼ŒRedis ä¼šé€‰æ‹©ä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥å­˜å‚¨æ•°æ®ï¼Œ&lt;strong&gt;è¾¾åˆ°èŠ‚çœå†…å­˜æ¶ˆè€—çš„ç›®çš„&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å…³é”®è®¾è®¡å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å†…å­˜ç´§å‡‘ï¼šå‹ç¼©åˆ—è¡¨å°†æ‰€æœ‰å…ƒç´ ç´§å‡‘åœ°å­˜å‚¨åœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œæ²¡æœ‰æŒ‡é’ˆç­‰é¢å¤–å¼€é”€ã€‚æ¯ä¸ªå…ƒç´ å‰éƒ½æœ‰ä¸€ä¸ªå‰å‘ç¼–ç å’Œåå‘ç¼–ç ï¼Œç”¨äºæŒ‡ç¤ºå‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œè¿™æ ·å¯ä»¥å¿«é€Ÿåœ°è¿›è¡Œå‰åéå†ï¼Œé¿å…äº†é“¾è¡¨ä¸­æŒ‡é’ˆçš„é¢å¤–å¼€é”€ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;çµæ´»æ€§ï¼šå‹ç¼©åˆ—è¡¨æ ¹æ®å­˜å‚¨çš„å…ƒç´ é•¿åº¦åŠ¨æ€è°ƒæ•´ç¼–ç æ–¹å¼ï¼Œå°äº 1 å­—èŠ‚çš„æ•´æ•°ã€1 å­—èŠ‚çš„æ•´æ•°ã€3 å­—èŠ‚çš„æ•´æ•°ç­‰ä¸åŒé•¿åº¦çš„ç¼–ç æ–¹å¼ï¼Œèƒ½å¤Ÿæå¤§åœ°èŠ‚çœå†…å­˜ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ€§èƒ½ä¸ç©ºé—´çš„å¹³è¡¡ï¼šå½“åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨å˜å¾—å¾ˆå¤§æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ›´é«˜æ•ˆçš„é“¾è¡¨æˆ–å“ˆå¸Œè¡¨ç»“æ„ã€‚è¿™ç§æŒ‰éœ€è°ƒæ•´çš„æ•°æ®ç»“æ„è®¾è®¡ï¼Œç¡®ä¿äº†åœ¨ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½æœ€ä¼˜ã€‚&lt;/p&gt;
&lt;h4 id="æ•´ä½“ç»“æ„å¸ƒå±€"&gt;æ•´ä½“ç»“æ„å¸ƒå±€
&lt;/h4&gt;&lt;pre tabindex="0"&gt;&lt;code&gt;area |&amp;lt;---- ziplist header ----&amp;gt;|&amp;lt;----------- entries -------------&amp;gt;|&amp;lt;-end-&amp;gt;|
size 4 bytes 4 bytes 2 bytes ? ? ? 1 byte
+---------+--------+-------+--------+--------+--------+-------+
| zlbytes | zltail | zllen | entry1 | entry2 | ... | zlend |
+---------+--------+-------+--------+--------+--------+-------+
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;####Header éƒ¨åˆ†è¯¦è§£&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µå&lt;/th&gt;
&lt;th&gt;é•¿åº¦/ç±»å‹&lt;/th&gt;
&lt;th&gt;ä½œç”¨&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;zlbytes&lt;/td&gt;
&lt;td&gt;uint32_t (4å­—èŠ‚)&lt;/td&gt;
&lt;td&gt;æ•´ä¸ª ziplist å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ï¼Œç”¨äºå†…å­˜é‡åˆ†é…å’Œè®¡ç®—æœ«ç«¯&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zltail&lt;/td&gt;
&lt;td&gt;uint32_t (4å­—èŠ‚)&lt;/td&gt;
&lt;td&gt;åˆ°è¾¾ ziplist è¡¨å°¾èŠ‚ç‚¹çš„åç§»é‡ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°å°¾èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zllen&lt;/td&gt;
&lt;td&gt;uint16_t (2å­—èŠ‚)&lt;/td&gt;
&lt;td&gt;ziplist ä¸­èŠ‚ç‚¹çš„æ•°é‡ã€‚å½“å€¼å°äº 65535 æ—¶ä¸ºå®é™…æ•°é‡ï¼›ç­‰äº 65535 æ—¶éœ€è¦éå†è®¡ç®—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zlend&lt;/td&gt;
&lt;td&gt;uint8_t (1å­—èŠ‚)&lt;/td&gt;
&lt;td&gt;å€¼ä¸º 255(0xFF)ï¼Œæ ‡è®° ziplist çš„æœ«ç«¯&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt;/* We use this function to receive information about a ziplist entry.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; * Note that this is not how the data is actually encoded, is just what we
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; * get filled by a function in order to operate more easily. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;typedef&lt;/span&gt; &lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;zlentry&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;prevrawlensize&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Bytes used to encode the previous entry len*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;prevrawlen&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Previous entry len. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;lensize&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Bytes used to encode this entry type/len.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; For example strings have a 1, 2 or 5 bytes
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; header. Integers always use a single byte.*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Bytes used to represent the actual entry.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; For strings this is just the string length
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; while for integers it is 1, 2, 3, 4, 8 or
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; 0 (for 4 bit immediate) depending on the
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; number range. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;headersize&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* prevrawlensize + lensize. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;encoding&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Set to ZIP_STR_* or ZIP_INT_* depending on
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; the entry encoding. However for 4 bits
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; immediate integers this can assume a range
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; of values and must be range-checked. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="cm"&gt;/* Pointer to the very start of the entry, that
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="cm"&gt; is, this points to prev-entry-len field. */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;zlentry&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h4 id="æ¸è¿›å¼-rehash"&gt;æ¸è¿›å¼ rehash
&lt;/h4&gt;&lt;p&gt;Redis çš„å“ˆå¸Œè¡¨åœ¨æ‰©å®¹æˆ–ç¼©å®¹æ—¶ä¸ä¼šä¸€æ¬¡æ€§è¿›è¡Œå…¨é‡ rehashã€‚&lt;/p&gt;
&lt;p&gt;ç›¸åï¼Œå®ƒé‡‡å–äº†&lt;strong&gt;æ¸è¿›å¼ rehash çš„æ–¹å¼&lt;/strong&gt;ï¼Œå°† rehash æ“ä½œåˆ†æ‘Šåˆ°åç»­çš„å¢åˆ æ”¹æŸ¥æ“ä½œä¸­ï¼Œä»è€Œé¿å…äº†é›†ä¸­çš„æ€§èƒ½æŠ–åŠ¨ã€‚&lt;/p&gt;
&lt;h2 id="3å…±äº«å¯¹è±¡æ± "&gt;3ã€å…±äº«å¯¹è±¡æ± 
&lt;/h2&gt;&lt;p&gt;Redis ä¸­æœ‰è®¸å¤šå¸¸ç”¨çš„å°æ•´æ•°ï¼Œä¾‹å¦‚ 0 åˆ° 9999ã€‚è¿™äº›æ•´æ•°é¢‘ç¹åœ°å‡ºç°åœ¨å„ç§å‘½ä»¤å’Œæ•°æ®æ“ä½œä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ï¼ŒRedis ä½¿ç”¨äº† &lt;strong&gt;å…±äº«å¯¹è±¡æ± ï¼ˆShared Object Poolï¼‰&lt;/strong&gt;ï¼Œå®ç°äº†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å¯¹è±¡å¤ç”¨ï¼šå¯¹äºå¸¸ç”¨çš„å°æ•´æ•°ï¼ŒRedis ä¼šåœ¨å¯åŠ¨æ—¶é¢„å…ˆåˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ªå…±äº«å¯¹è±¡æ± ä¸­ã€‚å½“ç³»ç»Ÿéœ€è¦è¿™äº›æ•´æ•°å¯¹è±¡æ—¶ï¼Œç›´æ¥ä»æ± ä¸­è·å–ï¼Œè€Œä¸éœ€è¦é‡å¤åˆ†é…å†…å­˜ã€‚è¿™å¤§å¤§å‡å°‘äº†å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ï¼Œæé«˜äº†ç³»ç»Ÿçš„æ•ˆç‡ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å†…å­˜èŠ‚çœï¼šå…±äº«å¯¹è±¡æ± æœ‰æ•ˆåœ°èŠ‚çœäº†å†…å­˜ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡ä½¿ç”¨è¿™äº›å¸¸é‡çš„åœºæ™¯ä¸­ã€‚é€šè¿‡å¯¹è±¡å¤ç”¨ï¼Œé¿å…äº†é¢‘ç¹çš„å†…å­˜ç”³è¯·å’Œåƒåœ¾å›æ”¶ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="4è¿‡æœŸè®¾è®¡"&gt;4ã€è¿‡æœŸè®¾è®¡
&lt;/h2&gt;&lt;p&gt;Redis æ”¯æŒä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚å½“é”®è¿‡æœŸåï¼Œå®ƒåº”è¯¥è¢«è‡ªåŠ¨åˆ é™¤ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶è€Œï¼Œè¿‡æœŸé”®çš„å¤„ç†éœ€è¦åœ¨æ€§èƒ½å’Œå‡†ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚Redis é‡‡ç”¨äº†ä¸€ç§ &lt;strong&gt;æƒ°æ€§åˆ é™¤ä¸å®šæœŸåˆ é™¤ç›¸ç»“åˆçš„ç­–ç•¥&lt;/strong&gt; æ¥å¤„ç†è¿‡æœŸé”®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æƒ°æ€§åˆ é™¤ï¼šå½“å®¢æˆ·ç«¯è®¿é—®ä¸€ä¸ªé”®æ—¶ï¼ŒRedis ä¼šæ£€æŸ¥è¯¥é”®æ˜¯å¦å·²ç»è¿‡æœŸã€‚å¦‚æœè¿‡æœŸï¼Œåˆ™ç«‹å³åˆ é™¤ã€‚è¿™ç§æ–¹å¼ä¸ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…ï¼Œå› ä¸ºåªåœ¨è®¿é—®æ—¶æ‰æ£€æŸ¥é”®çš„çŠ¶æ€ã€‚&lt;/li&gt;
&lt;li&gt;å®šæœŸåˆ é™¤ï¼šRedis æ¯éš”ä¸€æ®µæ—¶é—´ä¼šéšæœºæŠ½å–ä¸€éƒ¨åˆ†é”®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­å·²è¿‡æœŸçš„é”®ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒRedis å¯ä»¥é¿å…ç³»ç»Ÿä¸­å¤§é‡å­˜åœ¨è¿‡æœŸé”®è€Œæ— æ³•åŠæ—¶æ¸…ç†çš„æƒ…å†µã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æƒ°æ€§åˆ é™¤ç¡®ä¿è®¿é—®æ€§èƒ½ï¼Œå®šæœŸåˆ é™¤é¿å…å†…å­˜æ³„æ¼ã€‚é€šè¿‡æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç›¸ç»“åˆï¼ŒRedis å®ç°äº†è¿‡æœŸé”®çš„é«˜æ•ˆç®¡ç†ã€‚&lt;/p&gt;
&lt;h2 id="5æ•°æ®æŒä¹…åŒ–aof-é‡å†™æœºåˆ¶"&gt;5ã€æ•°æ®æŒä¹…åŒ–ï¼šAOF é‡å†™æœºåˆ¶
&lt;/h2&gt;&lt;p&gt;AOFï¼ˆAppend Only Fileï¼‰ æ˜¯ Redis çš„ä¸€ç§æ•°æ®æŒä¹…åŒ–æ–¹å¼ã€‚&lt;/p&gt;
&lt;p&gt;Redis ä¼šå°†æ‰€æœ‰å†™æ“ä½œä»¥è¿½åŠ çš„æ–¹å¼è®°å½•åˆ° AOF æ–‡ä»¶ä¸­ï¼Œä»¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚ç„¶è€Œï¼Œ&lt;strong&gt;éšç€æ—¶é—´æ¨ç§»ï¼ŒAOF æ–‡ä»¶å¯èƒ½ä¼šå˜å¾—éå¸¸å¤§&lt;/strong&gt;ï¼Œå½±å“æ¢å¤é€Ÿåº¦ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis å¼•å…¥äº† &lt;strong&gt;AOF é‡å†™ï¼ˆAOF Rewriteï¼‰&lt;/strong&gt; æœºåˆ¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¢é‡é‡å†™ï¼šAOF é‡å†™å¹¶ä¸ä¼šä¸­æ–­æ­£å¸¸çš„å†™æ“ä½œã€‚åœ¨é‡å†™æœŸé—´ï¼ŒRedis ä»ç„¶å¯ä»¥å°†æ–°çš„å†™æ“ä½œç»§ç»­è¿½åŠ åˆ°æ—§çš„ AOF æ–‡ä»¶ä¸­ï¼Œç¡®ä¿äº†é«˜å¹¶å‘å†™å…¥æ—¶çš„æŒä¹…åŒ–æ€§èƒ½ã€‚&lt;/li&gt;
&lt;li&gt;ç©ºé—´ä¼˜åŒ–ï¼šAOF é‡å†™è¿‡ç¨‹ä¸­ï¼ŒRedis å¹¶ä¸ä¼šç®€å•åœ°å¤åˆ¶æ‰€æœ‰å‘½ä»¤ï¼Œè€Œæ˜¯æ ¹æ®å½“å‰çš„æ•°æ®çŠ¶æ€ï¼Œç”Ÿæˆæœ€ç²¾ç®€çš„å‘½ä»¤é›†ã€‚å³ä½¿ä¸€ä¸ªé”®å€¼ç»è¿‡å¤šæ¬¡ä¿®æ”¹ï¼Œæœ€ç»ˆçš„ AOF æ–‡ä»¶ä¸­åªä¼šä¿ç•™ä¸€æ¡æœ€æœ‰æ•ˆçš„å‘½ä»¤ï¼Œä»è€Œå¤§å¹…å‡å°‘äº†æ–‡ä»¶å¤§å°ã€‚&lt;/li&gt;
&lt;li&gt;å¼‚æ­¥æ‰§è¡Œï¼šAOF é‡å†™æ˜¯é€šè¿‡å­è¿›ç¨‹å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸»è¿›ç¨‹ä¸ä¼šå—åˆ°å½±å“ï¼Œè¿™ä¿è¯äº†åœ¨æ‰§è¡Œé‡å†™çš„åŒæ—¶ï¼ŒRedis ä»ç„¶å¯ä»¥æä¾›é«˜æ•ˆçš„æœåŠ¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ğŸ˜‚ğŸ˜‚ğŸ˜‚&lt;/p&gt;</description></item><item><title>Redisä¸ºä»€ä¹ˆå¿«</title><link>https://0607pass.github.io/Blog/p/redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/</link><pubDate>Thu, 11 Dec 2025 14:47:00 +0800</pubDate><guid>https://0607pass.github.io/Blog/p/redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/</guid><description>&lt;img src="https://0607pass.github.io/Blog/images/postCover/redis.png" alt="Featured image of post Redisä¸ºä»€ä¹ˆå¿«" /&gt;&lt;h1 id="redisä¸ºä»€ä¹ˆå¿«"&gt;Redisä¸ºä»€ä¹ˆå¿«
&lt;/h1&gt;&lt;p&gt;&lt;img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F0b01e080-d346-48d6-aad1-5fad59cd4f56_3573x2280.jpeg"
loading="lazy"
alt="img"
&gt;&lt;/p&gt;
&lt;h2 id="ä¸»è¦æœ‰-3-ä¸ªæ–¹é¢çš„åŸå› åˆ†åˆ«æ˜¯å­˜å‚¨æ–¹å¼ä¼˜ç§€çš„çº¿ç¨‹æ¨¡å‹ä»¥åŠ-io-æ¨¡å‹é«˜æ•ˆçš„æ•°æ®ç»“æ„"&gt;ä¸»è¦æœ‰ 3 ä¸ªæ–¹é¢çš„åŸå› ï¼Œåˆ†åˆ«æ˜¯å­˜å‚¨æ–¹å¼ã€ä¼˜ç§€çš„çº¿ç¨‹æ¨¡å‹ä»¥åŠ IO æ¨¡å‹ã€é«˜æ•ˆçš„æ•°æ®ç»“æ„ã€‚
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Redis å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæä¾›å¿«é€Ÿçš„è¯»å†™é€Ÿåº¦ï¼Œç›¸æ¯”äºä¼ ç»Ÿçš„ç£ç›˜æ•°æ®åº“ï¼Œå†…å­˜è®¿é—®é€Ÿåº¦å¿«å¾—å¤šã€‚&lt;/li&gt;
&lt;li&gt;Redis ä½¿ç”¨å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨æ¨¡å‹ç»“åˆ I/O å¤šè·¯å¤ç”¨ï¼Œé¿å…äº†å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œæé«˜äº†å¹¶å‘å¤„ç†æ•ˆç‡ã€‚&lt;/li&gt;
&lt;li&gt;Redis æä¾›å¤šç§é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆç­‰ï¼‰ï¼Œè¿™äº›ç»“æ„ç»è¿‡ä¼˜åŒ–ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®Œæˆå„ç§æ“ä½œ&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>